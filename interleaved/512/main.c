#include <stdio.h>

#include "params.h"
#include "ntt.h"

static void naivemul(uint16_t *r, const uint16_t *a, const uint16_t *b)
{
  uint16_t t[2*KYBER_N];
  int i,j;
  
   
  /* Schoolbook multiplication of a and b, store result in t */
  for(i=0;i<2*KYBER_N;i++)
    t[i] = 0;

  for(i=0;i<KYBER_N;i++)
  {
    for(j=0;j<KYBER_N;j++)
    {
      t[i+j] += ((uint32_t)a[i] * (uint32_t)b[j]) % KYBER_Q;
      t[i+j] %= KYBER_Q;
    }
  }

  /* Reduce t modulo (X^256 + 1); store result in r */
  for(i=0;i<KYBER_N;i++)
    r[i] = (t[i] + 2*KYBER_Q - t[i+KYBER_N]) % KYBER_Q;
}



int main(void)
{
  uint16_t a[256], b[256], r1[256], r2[256];
  FILE* urandom;
  //uint16_t r1[256], r2[256];
  int i;

 /* Initialize a and b with random coefficients */
  urandom = fopen("/dev/urandom", "r");
  fread(a, 2, KYBER_N, urandom);
  fread(b, 2, KYBER_N, urandom);
  for(i=0;i<KYBER_N;i++)
  {
    a[i] %= KYBER_Q;
    b[i] %= KYBER_Q;
  }
  fclose(urandom); 


	/*uint16_t a[] = {0,128,64,192,32,160,96,224,16,144,80,208,48,176,112,240, \
     8,136,72,200,40,168,104,232,24,152,88,216,56,184,120,248, \
     4,132,68,196,36,164,100,228,20,148,84,212,52,180,116,244, \
     12,140,76,204,44,172,108,236,28,156,92,220,60,188,124,252, \
     2,130,66,194,34,162,98,226,18,146,82,210,50,178,114,242, \
     10,138,74,202,42,170,106,234,26,154,90,218,58,186,122,250, \
     6,134,70,198,38,166,102,230,22,150,86,214,54,182,118,246, \
     14,142,78,206,46,174,110,238,30,158,94,222,62,190,126,254, \
     1,129,65,193,33,161,97,225,17,145,81,209,49,177,113,241, \
     9,137,73,201,41,169,105,233,25,153,89,217,57,185,121,249, \
     5,133,69,197,37,165,101,229,21,149,85,213,53,181,117,245, \
     13,141,77,205,45,173,109,237,29,157,93,221,61,189,125,253, \
     3,131,67,195,35,163,99,227,19,147,83,211,51,179,115,243, \
     11,139,75,203,43,171,107,235,27,155,91,219,59,187,123,251, \
     7,135,71,199,39,167,103,231,23,151,87,215,55,183,119,247, \
     15,143,79,207,47,175,111,239,31,159,95,223,63,191,127,255};

	uint16_t b[] = {0,384,192,576,96,480,288,672,48,432,240,624,144,528,336,720,24, \
		408,216,600,120,504,312,696,72,456,264,648,168,552,360,744,12, \
		396,204,588,108,492,300,684,60,444,252,636,156,540,348,732,36, \
		420,228,612,132,516,324,708,84,468,276,660,180,564,372,756,6, \
		390,198,582,102,486,294,678,54,438,246,630,150,534,342,726,30, \
		414,222,606,126,510,318,702,78,462,270,654,174,558,366,750,18, \
		402,210,594,114,498,306,690,66,450,258,642,162,546,354,738,42, \
		426,234,618,138,522,330,714,90,474,282,666,186,570,378,762,3, \
		387,195,579,99,483,291,675,51,435,243,627,147,531,339,723,27, \
		411,219,603,123,507,315,699,75,459,267,651,171,555,363,747,15, \
		399,207,591,111,495,303,687,63,447,255,639,159,543,351,735,39, \
		423,231,615,135,519,327,711,87,471,279,663,183,567,375,759,9, \
		393,201,585,105,489,297,681,57,441,249,633,153,537,345,729,33, \
		417,225,609,129,513,321,705,81,465,273,657,177,561,369,753,21, \
		405,213,597,117,501,309,693,69,453,261,645,165,549,357,741,45, \
		429,237,621,141,525,333,717,93,477,285,669,189,573,381,765};*/

  /* Naive multiplication */
  naivemul(r1, a, b);

  /* NTT-based multiplication */
  ntt(a);
  ntt(b);
  for(i=0;i<KYBER_N;i++)
    r2[i] = ((uint32_t)a[i] * (uint32_t)b[i]) % KYBER_Q;
  invntt(r2);


  /* Compare results of the two multiplication approaches */
  for(i=0;i<KYBER_N;i++)
    if((r1[i]-r2[i]) % KYBER_Q) printf("error at coefficient %d\n", i);

  return 0;
}
